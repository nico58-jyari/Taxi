'use strict';

/* =========================
   TAXIæ—¥å ± PRO - app.js
   ========================= */

// ===== Storage Keys =====
const DB_KEY = 'TAXI_PRO_FIXED_STORAGE_V1';
const SET_KEY = 'TAXI_PRO_SETTINGS_FIXED';

// ===== State =====
let state = {
  status: 'OFF', // OFF | WAITING | RIDING | FINISHING
  currentShift: null,
  shifts: [],
  editingIndex: -1,
  tempRide: { type: 'ä¸€èˆ¬', startPlace: '', endPlace: '', memo: '', tip: 0, hiway: 0 },
  settings: { mode: 'éš”æ—¥å‹¤å‹™', showMemo: true, showDist: true, closingDay: 19 }
};

// ===== Init =====
window.onload = () => {
  try {
    const d = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
    state.shifts = d.shifts || [];
    state.currentShift = d.currentShift || null;
    state.status = d.status || 'OFF';
    state.settings = JSON.parse(localStorage.getItem(SET_KEY) || JSON.stringify(state.settings));

    startClock();
    render();
  } catch (e) {
    console.error(e);
  }
};

// ===== Utils =====
function getNet(val) {
  if (!val || val <= 0) return 0;
  const taxEx = val / 1.1;
  return Math.ceil(taxEx / 10) * 10;
}

function save() {
  localStorage.setItem(
    DB_KEY,
    JSON.stringify({ shifts: state.shifts, currentShift: state.currentShift, status: state.status })
  );
}

function startClock() {
  const el = document.getElementById('clock');
  const u = () => {
    if (!el) return;
    el.innerText = new Date().toLocaleString('ja-JP', {
      month: '2-digit',
      day: '2-digit',
      weekday: 'short',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  };
  u();
  setInterval(u, 1000);
}

function setType(t) {
  state.tempRide.type = t;
  ['ä¸€èˆ¬', 'ç„¡ç·š', 'ä»˜å¾…'].forEach(type => {
    const b = document.getElementById(`type-${type}`);
    if (b) b.className = `type-btn ${t === type ? 'active' : ''}`;
  });
}

function applyDisplaySettings() {
  const memoWrap = document.getElementById('form-memo-area');
  const distWrap = document.getElementById('form-dist-area');
  if (memoWrap) state.settings.showMemo ? memoWrap.classList.remove('hidden') : memoWrap.classList.add('hidden');
  if (distWrap) state.settings.showDist ? distWrap.classList.remove('hidden') : distWrap.classList.add('hidden');
}

async function getGPS() {
  return new Promise(r => {
    if (!navigator.geolocation) return r('åœ°ç‚¹ä¸æ˜');

    navigator.geolocation.getCurrentPosition(
      async p => {
        try {
          const res = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}&accept-language=ja`
          );
          const j = await res.json();
          const a = j.address || {};
          const cityPart = a.city || a.ward || a.town || a.village || a.county || '';
          const townPart = a.quarter || a.suburb || a.neighbourhood || a.city_district || '';
          r((cityPart + townPart) || 'å–å¾—åœ°ç‚¹');
        } catch {
          r('å–å¾—ã‚¨ãƒ©ãƒ¼');
        }
      },
      () => r('GPSãªã—'),
      { enableHighAccuracy: true }
    );
  });
}

function resetInputs() {
  ['inp-fare', 'inp-hiway', 'inp-tip', 'inp-dist'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  // ãƒ¡ãƒ¢ã¯ã€Œè³ƒèµ°ä¸­â‡„æ¸…ç®—ã€ã§å¼•ãç¶™ããŸã„ã®ã§ã€ã“ã“ã§ã¯æ¶ˆã•ãªã„
}

// ===== ãƒ¡ãƒ¢/é«˜é€Ÿ/ãƒãƒƒãƒ— é–‹é–‰ =====
function toggleFareExtra(kind) {
  const hiway = document.getElementById('hiway-area');
  const tip = document.getElementById('tip-area');
  const memo = document.getElementById('fare-memo-area');

  if (kind === 'hiway' && hiway) hiway.classList.toggle('hidden');
  if (kind === 'tip' && tip) tip.classList.toggle('hidden');
  if (kind === 'memo' && memo) memo.classList.toggle('hidden');
}

// ===== Render =====
function render() {
  const ctrl = document.getElementById('main-controls');
  const form = document.getElementById('input-form');
  const fareSec = document.getElementById('fare-section');
  const typeBox = document.getElementById('type-selector-container');
  const endBtnBox = document.getElementById('end-shift-container');
  const routeBox = document.getElementById('route-display-area');

  const actionBtn = document.getElementById('action-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const ft = document.getElementById('form-title');

  if (!ctrl) return;
  ctrl.innerHTML = '';

  // ã‚¿ã‚¤ãƒˆãƒ«ã®â€œæ®‹ã‚Šã‚«ã‚¹â€ã‚’æ¯å›ãƒªã‚»ãƒƒãƒˆï¼ˆé‡è¦ï¼‰
  if (ft) {
    ft.classList.remove('breath-red');
    // ã‚‚ã— tailwind ã®èµ¤ã‚¯ãƒ©ã‚¹ã‚‚ä»˜ã‘ã¦ã‚‹ãªã‚‰ã“ã‚Œã‚‚å¤–ã™
    ft.classList.remove('text-red-500');
  }

  // ===== OFF =====
  if (state.status === 'OFF') {
    ctrl.innerHTML =
      `<button onclick="startShift()" class="btn-main bg-emerald-600 text-white shadow-emerald-100">
        å‹¤å‹™é–‹å§‹ï¼ˆå‡ºåº«ï¼‰
      </button>`;

    if (form) form.classList.add('hidden');
    if (typeBox) typeBox.classList.add('hidden');
    if (endBtnBox) endBtnBox.classList.add('hidden');
    if (routeBox) routeBox.classList.add('hidden');
    if (fareSec) fareSec.classList.add('hidden');

    if (actionBtn) actionBtn.classList.add('hidden');
    if (cancelBtn) cancelBtn.classList.add('hidden');

    updateDash();
    if (state.currentShift) renderCurrentLogs();
    else renderMainShiftHistory();
    save();
    return;
  }

  // ===== å‹¤å‹™ä¸­å…±é€š =====
  if (typeBox) typeBox.classList.remove('hidden');
  setType(state.tempRide.type);

  // ===== WAITING =====
  if (state.status === 'WAITING') {
    ctrl.innerHTML =
      `<button onclick="startRide()" class="btn-main bg-blue-600 text-white shadow-blue-100">
        ä¹—è»Šé–‹å§‹
      </button>`;

    if (form) form.classList.add('hidden');
    if (endBtnBox) endBtnBox.classList.remove('hidden');
    if (routeBox) routeBox.classList.add('hidden');
    if (fareSec) fareSec.classList.add('hidden');

    if (actionBtn) actionBtn.classList.add('hidden');

    if (cancelBtn) {
      cancelBtn.classList.add('hidden');
      cancelBtn.onclick = null;
      cancelBtn.innerText = '';
    }

  // ===== RIDING =====
  } else if (state.status === 'RIDING') {
    ctrl.innerHTML =
      `<button onclick="handleMainAction()" class="btn-main bg-blue-600 text-white shadow-blue-100">
        ãŠå®¢æ§˜é™è»Šï¼ˆæ¸…ç®—ã¸ï¼‰
      </button>`;

    if (form) form.classList.remove('hidden');
    if (endBtnBox) endBtnBox.classList.add('hidden');
    if (routeBox) routeBox.classList.add('hidden');
    if (fareSec) fareSec.classList.add('hidden');

    if (ft) {
      ft.innerText = 'è³ƒèµ°ä¸­';
      ft.classList.add('breath-red'); // â† ç‚¹æ»…ã‚¯ãƒ©ã‚¹
      // ã‚‚ã—è‰²ã‚‚ tailwind ã§ä»˜ã‘ãŸã„ãªã‚‰ã“ã‚Œã‚‚OK
      ft.classList.add('text-red-500');
    }

    // è³ƒèµ°ä¸­ã¯ä¿å­˜ãƒœã‚¿ãƒ³ã¯ä½¿ã‚ãªã„
    if (actionBtn) actionBtn.classList.add('hidden');

    // è³ƒèµ°ä¸­ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯å¾…æ©Ÿã¸æˆ»ã™
    if (cancelBtn) {
      cancelBtn.classList.remove('hidden');
      cancelBtn.innerText = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆå¾…æ©Ÿã¸ï¼‰';
      cancelBtn.onclick = cancelRideToWaiting;
    }

    // ãƒ¡ãƒ¢å¼•ãç¶™ãï¼ˆinp-memo ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
    const memoEl = document.getElementById('inp-memo');
    if (memoEl && typeof state.tempRide.memo === 'string') {
      memoEl.value = state.tempRide.memo;
    }

    applyDisplaySettings();

  // ===== FINISHING =====
  } else if (state.status === 'FINISHING') {
    if (form) form.classList.remove('hidden');
    if (routeBox) routeBox.classList.remove('hidden');
    if (fareSec) fareSec.classList.remove('hidden');
    if (endBtnBox) endBtnBox.classList.add('hidden');

    const sp = document.getElementById('start-p-display');
    const ep = document.getElementById('end-p-display');

    if (ft) ft.innerText = 'æ¸…ç®—å…¥åŠ›';
    if (sp) sp.innerText = state.tempRide.startPlace;
    if (ep) ep.innerText = state.tempRide.endPlace || 'å–å¾—ä¸­...';

    if (actionBtn) {
      actionBtn.classList.remove('hidden');
      actionBtn.innerText = 'è¨˜éŒ²ã‚’ä¿å­˜';
    }

    if (cancelBtn) {
      cancelBtn.classList.remove('hidden');
      cancelBtn.innerText = 'æˆ»ã‚‹ï¼ˆè³ƒèµ°ä¸­ã¸ï¼‰';
      cancelBtn.onclick = backToRiding;
    }

    // æ¸…ç®—ã§ã‚‚ãƒ¡ãƒ¢å¼•ãç¶™ãï¼ˆinp-memo ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
    const memoEl = document.getElementById('inp-memo');
    if (memoEl && typeof state.tempRide.memo === 'string') {
      memoEl.value = state.tempRide.memo;
    }

    applyDisplaySettings();
  }

  updateDash();
  if (state.currentShift) renderCurrentLogs();
  else renderMainShiftHistory();

  save();
}


// ===== Flow =====
function startShift() {
  state.currentShift = { date: new Date().toLocaleDateString('ja-JP'), rides: [] };
  state.status = 'WAITING';
  state.tempRide.type = 'ä¸€èˆ¬';
  render();
}

async function startRide() {
  state.status = 'RIDING';
  state.editingIndex = -1;

  state.tempRide = {
    type: state.tempRide.type || 'ä¸€èˆ¬',
    startPlace: 'å–å¾—ä¸­...',
    endPlace: '',
    memo: '',
    tip: 0,
    hiway: 0
  };

  resetInputs();
  render();

  state.tempRide.startPlace = await getGPS();
  render();
}

function backToRiding() {
  // æ¸…ç®—ä¸­ã®å…¥åŠ›ã¯ã€Œç ´æ£„ã—ãªã„ã€æ–¹é‡ï¼šãƒ¡ãƒ¢ã¯tempRideã«ä¿æŒã•ã‚Œã¦ã‚‹ã®ã§OK
  // ãŸã ã—çµ‚ç‚¹ã¯å–ã‚Šç›´ã—
  state.status = 'RIDING';
  state.tempRide.endPlace = '';
  render();
}

async function handleMainAction() {
  // RIDING â†’ FINISHING
  if (state.status === 'RIDING') {
    // è³ƒèµ°ä¸­ã§ãƒ¡ãƒ¢ã‚’æ‰“ã£ã¦ãŸã‚‰ä¿æŒ
    const memoEl = document.getElementById('inp-memo');
    state.tempRide.memo = (memoEl && memoEl.value) ? memoEl.value : (state.tempRide.memo || '');

    state.status = 'FINISHING';
    render();

    state.tempRide.endPlace = await getGPS();
    render();
    return;
  }

  // FINISHING â†’ ä¿å­˜
  if (!state.currentShift) return;

  const f = Number(parseInt((document.getElementById('inp-fare') || {}).value) || 0);
  const h = Number(parseInt((document.getElementById('inp-hiway') || {}).value) || 0);
  const tip = Number(parseInt((document.getElementById('inp-tip') || {}).value) || 0);
  const dist = Number(parseFloat((document.getElementById('inp-dist') || {}).value) || 0);

  const memo = ((document.getElementById('inp-memo') || {}).value || '').trim();

  const d = {
    ...state.tempRide,
    fare: Math.max(0, f - h),
    hiway: Math.max(0, h),
    tip: Math.max(0, tip),
    dist,
    memo,
    time: state.editingIndex > -1
      ? state.currentShift.rides[state.editingIndex].time
      : new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
  };

  if (!state.currentShift.rides) state.currentShift.rides = [];
  if (state.editingIndex > -1) state.currentShift.rides[state.editingIndex] = d;
  else state.currentShift.rides.push(d);

  // æ¬¡ã¸
  state.status = 'WAITING';
  state.editingIndex = -1;
  state.tempRide = { type: 'ä¸€èˆ¬', startPlace: '', endPlace: '', memo: '', tip: 0, hiway: 0 };

  resetInputs();

  // ãƒ¡ãƒ¢æ¬„ã¯é–‰ã˜ã¦ãŠãï¼ˆé–‹ã„ã¦ã‚‹ã¨ã€Œæ¬¡ã®ä¹—è»Šã€ã§è¦‹ãŸç›®ãŒç´›ã‚‰ã‚ã—ã„ã®ã§ï¼‰
  const memoArea = document.getElementById('fare-memo-area');
  if (memoArea) memoArea.classList.add('hidden');

  render();
}

function cancelRideToWaiting() {
  if (!confirm('ã“ã®ä¹—è»Šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å¾…æ©Ÿã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\nï¼ˆä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰')) return;
  state.status = 'WAITING';
  state.editingIndex = -1;
  state.tempRide = { type: state.tempRide.type || 'ä¸€èˆ¬', startPlace: '', endPlace: '', memo: '', tip: 0, hiway: 0 };

  resetInputs();
  // ãƒ¡ãƒ¢æ¬„ã¯é–‰ã˜ã‚‹
  const memoArea = document.getElementById('fare-memo-area');
  if (memoArea) memoArea.classList.add('hidden');

  render();
}

// ===== Dashboard =====
function updateDash() {
  const a = state.currentShift || { rides: [] };
  const tf = a.rides.reduce((v, r) => v + (Number(r.fare) || 0), 0);

  const cEl = document.getElementById('dash-count');
  const nEl = document.getElementById('dash-net');
  const sEl = document.getElementById('dash-sales');
  const kEl = document.getElementById('dash-km');

  if (cEl) cEl.innerText = a.rides.length;
  if (nEl) nEl.innerText = getNet(tf).toLocaleString();
  if (sEl) sEl.innerText = tf.toLocaleString();

  const km = a.rides.reduce((v, r) => v + (Number(r.dist) || 0), 0).toFixed(1);
  if (kEl) kEl.innerText = km;
}

// ===== Main Logs =====
function renderCurrentLogs() {
  const el = document.getElementById('main-current-logs');
  if (!el) return;

  el.innerHTML = '';
  if (!state.currentShift) return;

  el.innerHTML = `<h3 class="text-[10px] text-gray-400 text-center uppercase tracking-widest mb-2 mt-4">Current Logs</h3>`;

  [...state.currentShift.rides].reverse().forEach((r, i) => {
    const idx = state.currentShift.rides.length - 1 - i;
    const shown = (Number(r.fare) || 0).toLocaleString();

    el.innerHTML += `
      <div class="bg-white p-3 rounded-xl border mb-2 flex justify-between items-center text-sm shadow-sm">
        <div>
          <b>${r.time}</b> Â¥${shown} [${r.type}]<br>
          <span class="text-[9px] text-gray-400">${r.endPlace || ''}</span>
        </div>
        <div class="flex gap-2">
          <button onclick="editRide(${idx})" class="text-blue-500 text-[10px] font-bold">ç·¨é›†</button>
          <button onclick="deleteRide(${idx})" class="text-red-400 text-[10px] font-bold">å‰Šé™¤</button>
        </div>
      </div>`;
  });
}

function editRide(idx) {
  if (!state.currentShift) return;
  const r = state.currentShift.rides[idx];
  if (!r) return;

  state.editingIndex = idx;
  state.tempRide = { ...r };
  state.status = 'FINISHING';
  render();

  // å…¥åŠ›æ¬„ã¯ã€Œæ”¯æ‰•åˆè¨ˆï¼ˆç¨è¾¼ï¼‰ã€ãªã®ã§ã€ä¿å­˜å€¤ï¼ˆfare+hiwayï¼‰ã‚’æˆ»ã™
  const fare = (Number(r.fare) || 0) + (Number(r.hiway) || 0);

  const fEl = document.getElementById('inp-fare');
  const hEl = document.getElementById('inp-hiway');
  const tEl = document.getElementById('inp-tip');
  const dEl = document.getElementById('inp-dist');
  const mEl = document.getElementById('inp-memo');

  if (fEl) fEl.value = fare;
  if (hEl) hEl.value = Number(r.hiway) || 0;
  if (tEl) tEl.value = Number(r.tip) || 0;
  if (dEl) dEl.value = Number(r.dist) || 0;
  if (mEl) mEl.value = r.memo || '';
}

function deleteRide(idx) {
  if (!state.currentShift) return;
  if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  state.currentShift.rides.splice(idx, 1);
  render();
}

// ===== Main Recent Shifts =====
function renderMainShiftHistory() {
  const el = document.getElementById('main-current-logs');
  if (!el) return;

  el.innerHTML = `<h3 class="text-[10px] text-gray-400 text-center uppercase tracking-widest mb-2 mt-4">Recent Shifts</h3>`;

  if (!state.shifts || state.shifts.length === 0) {
    el.innerHTML += `<div class="text-center text-xs text-gray-400 py-6">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  const list = state.shifts.slice(0, 10);
  list.forEach((s, idx) => {
    const dailyTotalFare = s.rides.reduce((v, r) => v + (Number(r.fare) || 0), 0);
    const dailyNet = getNet(dailyTotalFare);
    const dailyGross = dailyTotalFare;

    const detId = `mainhist-det-${idx}`;

    el.innerHTML += `
      <div class="bg-white rounded-2xl border shadow-sm overflow-hidden mb-3">
        <div class="p-4 flex justify-between items-center font-bold cursor-pointer" onclick="toggleMainHist('${detId}')">
          <span>${s.date} ${s.rides.length}ä»¶</span>
          <div class="text-right">
            <div class="text-blue-600 text-lg leading-tight">Â¥${dailyNet.toLocaleString()}</div>
            <div class="text-gray-400 text-[10px] font-normal">ç¨è¾¼ Â¥${dailyGross.toLocaleString()}</div>
          </div>
        </div>
        <div id="${detId}" class="hidden p-4 border-t bg-gray-50">
          ${s.rides.map(r => {
            const shown = (Number(r.fare) || 0).toLocaleString();
            return `
              <div class="py-2 border-b last:border-0 border-gray-200">
                <div class="flex justify-between font-bold text-[11px] mb-0.5">
                  <span>${r.time} [${r.type}] ${r.endPlace || ''}</span>
                  <span>Â¥${shown}</span>
                </div>
              </div>`;
          }).join('')}
        </div>
      </div>
    `;
  });
}

function toggleMainHist(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle('hidden');
}

// ===== Finish / Modal =====
function executeFinish() {
  if (!state.currentShift) return;

  state.shifts.unshift(JSON.parse(JSON.stringify(state.currentShift)));
  state.currentShift = null;
  state.status = 'OFF';

  save();
  render();
  renderShare();

  openModal(`
    <div class="p-8 text-center">
      <div class="text-6xl mb-4">ğŸ†</div>
      <p class="font-black text-xl mb-2 text-gray-800">å¸°åº«å®Œäº†ï¼</p>
      <p class="text-gray-500 text-sm mb-8 leading-relaxed">æœ¬æ—¥ã®å‹¤å‹™ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚</p>
      <button onclick="closeModal(); switchPage('main');" class="w-full py-4 rounded-2xl bg-blue-600 text-white font-black shadow-lg text-lg">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</button>
    </div>
  `);
}

function openModal(h) {
  const c = document.getElementById('modal-content');
  const m = document.getElementById('modal-container');
  if (!c || !m) return;
  c.innerHTML = h;
  m.classList.remove('hidden');
}

function closeModal() {
  const m = document.getElementById('modal-container');
  if (!m) return;
  m.classList.add('hidden');
}

// ===== Pages =====
function switchPage(p) {
  ['main', 'history', 'share'].forEach(id => {
    const page = document.getElementById('page-' + id);
    const nav = document.getElementById('nav-' + id);
    if (page) page.classList.toggle('hidden', id !== p);
    if (nav) nav.classList.toggle('active', id === p);
  });

  if (p === 'history') renderHistory();
  if (p === 'share') renderShare();
}

// ===== History =====
function clearSearch() {
  const input = document.getElementById('history-search');
  if (!input) return;
  input.value = '';
  renderHistory();
  input.focus();
}

function calculatePeriodTotal() {
  const closingDay = parseInt(state.settings.closingDay) || 19;
  const now = new Date();

  let start, end;
  if (now.getDate() > closingDay) {
    start = new Date(now.getFullYear(), now.getMonth(), closingDay + 1);
    end = new Date(now.getFullYear(), now.getMonth() + 1, closingDay);
  } else {
    start = new Date(now.getFullYear(), now.getMonth() - 1, closingDay + 1);
    end = new Date(now.getFullYear(), now.getMonth(), closingDay);
  }

  let netTotal = 0, grossTotal = 0;
  const allShifts = state.currentShift ? [state.currentShift, ...state.shifts] : state.shifts;

  allShifts.forEach(s => {
    const sDate = new Date(s.date);
    if (sDate >= start && sDate <= end) {
      s.rides.forEach(r => {
        netTotal += (Number(r.fare) || 0);
        grossTotal += (Number(r.fare) || 0);
      });
    }
  });

  return `
    <div class="card bg-slate-800 text-white shadow-md">
      <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">çµ¦ä¸æœŸé–“ç´¯è¨ˆ (${(start.getMonth()+1)}/${start.getDate()} ã€œ)</div>
      <div class="flex justify-between items-end">
        <div>
          <span class="text-[9px] text-emerald-400 font-bold block">ç¨æŠœå–¶åç´¯è¨ˆ</span>
          <span class="text-2xl font-black text-yellow-400">Â¥${getNet(netTotal).toLocaleString()}</span>
        </div>
        <div class="text-right">
          <span class="text-[9px] text-slate-400 block uppercase">ç¨è¾¼åˆè¨ˆ</span>
          <span class="text-sm font-bold">Â¥${grossTotal.toLocaleString()}</span>
        </div>
      </div>
    </div>`;
}

function renderHistory() {
  const el = document.getElementById('history-content');
  const input = document.getElementById('history-search');
  const clearBtn = document.getElementById('search-clear-btn');
  const totalEl = document.getElementById('period-total-card');
  if (!el || !input) return;

  const query = (input.value || '').toLowerCase();
  el.innerHTML = '';

  if (clearBtn) {
    if (query !== '') clearBtn.classList.remove('hidden');
    else clearBtn.classList.add('hidden');
  }
  if (totalEl) totalEl.innerHTML = calculatePeriodTotal();

  if (!state.shifts || state.shifts.length === 0) {
    el.innerHTML = `<div class="text-center text-xs text-gray-400 py-6">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  state.shifts.forEach((s, idx) => {
    if (query !== '') {
      const hit =
        (s.date || '').toLowerCase().includes(query) ||
        s.rides.some(r =>
          ((r.endPlace || '').toLowerCase().includes(query)) ||
          ((r.type || '').toLowerCase().includes(query))
        );
      if (!hit) return;
    }

    const dailyTotalFare = s.rides.reduce((v, r) => v + (Number(r.fare) || 0), 0);
    const dailyNet = getNet(dailyTotalFare);
    const dailyGross = dailyTotalFare;

    el.innerHTML += `
      <div class="card p-0 overflow-hidden shadow-sm">
        <div class="p-4 bg-white flex justify-between items-center font-bold" onclick="toggleHist(${idx})">
          <span>${s.date} ${s.rides.length}ä»¶</span>
          <div class="text-right">
            <span class="text-blue-600 block text-lg leading-tight">Â¥${dailyNet.toLocaleString()}</span>
            <span class="text-gray-400 text-[10px] font-normal">ç¨è¾¼ Â¥${dailyGross.toLocaleString()}</span>
          </div>
        </div>
        <div id="hist-det-${idx}" class="hist-detail p-4 border-t bg-gray-50">
          ${s.rides.map(r => {
            const shown = (Number(r.fare) || 0).toLocaleString();
            return `
              <div class="py-2 border-b last:border-0 border-gray-200">
                <div class="flex justify-between font-bold text-[11.5px] mb-0.5">
                  <span>${r.time} [${r.type}] ${r.endPlace || ''}</span>
                  <span>Â¥${shown}</span>
                </div>
              </div>`;
          }).join('')}
        </div>
      </div>
    `;
  });
}

function toggleHist(idx) {
  const el = document.getElementById(`hist-det-${idx}`);
  if (!el) return;
  el.classList.toggle('open');
}

// ===== Share =====
function renderShare() {
  const sn = document.getElementById('share-net');
  if (!sn) return;

  if (!state.currentShift) {
    const dm = document.getElementById('share-date-mode');
    const sc = document.getElementById('share-count');
    const sk = document.getElementById('share-km');
    const st = document.getElementById('share-top3');

    if (dm) dm.innerText = 'æœªå‡ºåº«';
    sn.innerText = '0';
    if (sc) sc.innerText = '0';
    if (sk) sk.innerText = '0.0';
    if (st) st.innerHTML = '<p class="text-center text-gray-500 text-[10px] py-4 uppercase">No Data</p>';
    return;
  }

  const a = state.currentShift;
  const tf = a.rides.reduce((v, r) => v + (Number(r.fare) || 0), 0);

  const dm = document.getElementById('share-date-mode');
  const sc = document.getElementById('share-count');
  const sk = document.getElementById('share-km');
  const sdb = document.getElementById('share-dist-box');
  const st = document.getElementById('share-top3');

  if (dm) dm.innerText = `${a.date} / ${state.settings.mode}`;
  sn.innerText = getNet(tf).toLocaleString();
  if (sc) sc.innerText = a.rides.length;
  if (sk) sk.innerText = a.rides.reduce((v, r) => v + (Number(r.dist) || 0), 0).toFixed(1);
  if (sdb) sdb.style.display = state.settings.showDist ? 'block' : 'none';

  const top3 = [...a.rides].sort((x, y) => (Number(y.fare) || 0) - (Number(x.fare) || 0)).slice(0, 3);
  const icons = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];

  if (!st) return;
  st.innerHTML = top3.map((r, i) => `
    <div class="flex justify-between items-center py-4 border-b border-white/10 last:border-0">
      <div class="flex items-center gap-3 overflow-hidden">
        <span class="text-4xl flex-shrink-0">${icons[i]}</span>
        <div class="text-left overflow-hidden">
          <p class="text-[8px] text-gray-500 uppercase font-bold">${r.time} [${r.type}]</p>
          <p class="text-[11px] text-white font-bold truncate">${r.endPlace || 'åœ°ç‚¹ä¸æ˜'}</p>
        </div>
      </div>
      <span class="text-2xl font-black text-white whitespace-nowrap ml-2">Â¥${getNet(Number(r.fare) || 0).toLocaleString()}</span>
    </div>
  `).join('') || '<p class="text-center text-[10px] py-4 uppercase">No Data Recorded</p>';
}

// ===== Settings Modalï¼ˆå¿…è¦ãªã‚‰ã‚ãªãŸã®æ—¢å­˜ã‚’è²¼ã‚Šæˆ»ã—ã¦OKï¼‰ =====
function openSettings() { alert('è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ä»Šã¯çœç•¥ï¼ˆæ—¢å­˜ã®ã‚’æˆ»ã—ã¦OKï¼‰'); }

// ===== PWA Update Bar / Service Worker =====
// SWã¯ä»Šã¯æ­¢ã‚ã¦ãŠãï¼ˆç™»éŒ²ã—ãªã„ï¼‰
(function registerSW() {
  if (!('serviceWorker' in navigator)) return;
  let refreshing = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (refreshing) return;
    refreshing = true;
    location.reload();
  });
})();
