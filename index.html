<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>TAXIæ—¥å ± PRO Ver 8.5
  
  </title>

  <meta property="og:title" content="TAXIæ—¥å ± PRO" />
  <meta property="og:description" content="ç¾å½¹ä¹—å‹™å“¡ã®ãŸã‚ã®å–¶åç®¡ç†ã‚¢ãƒ—ãƒªã€‚åœ°ç‚¹è‡ªå‹•å–å¾—ã€å¾©å…ƒæ©Ÿèƒ½ã‚’æ­è¼‰ã€‚" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://toprize.boo.jp/TAXI/OGP.png" />
  <meta name="twitter:card" content="summary" />

  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="TAXIæ—¥å ±" />
  <link rel="apple-touch-icon-precomposed" href="icon01.png" />
  <link rel="icon" type="image/png" href="icon01.png" />
  <meta name="theme-color" content="#0f172a" />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: sans-serif; background-color: #f8fafc; overflow-x: hidden; }
    .btn-main { width: 100%; padding: 18px; font-size: 1.25rem; font-weight: bold; border-radius: 16px; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .btn-main:active { transform: translateY(2px); box-shadow: none; }
    .card { background: white; padding: 1.25rem; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    .status-container { display: flex; background: #1e293b; color: white; border-radius: 16px; overflow: hidden; margin-top: 1rem; margin-bottom: 0.5rem; }
    .status-item { flex-direction: column; display: flex; justify-content: center; align-items: center; padding: 12px 2px; border-right: 1px solid #334155; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; border-top: 1px solid #e2e8f0; padding: 10px 0 30px 0; z-index: 50; height: 115px; }
    .nav-item { flex: 1; text-align: center; font-size: 0.85rem; font-weight: bold; color: #94a3b8; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .nav-item.active { color: #3b82f6; }
    .nav-icon { font-size: 2.8rem; display: block; line-height: 1; margin-bottom: 4px; }

    .toggle-switch { width: 44px; height: 24px; background: #e2e8f0; border-radius: 12px; position: relative; cursor: pointer; transition: 0.3s; }
    .toggle-switch::after { content: ''; width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; }
    input:checked + .toggle-switch { background: #3b82f6; }
    input:checked + .toggle-switch::after { left: 22px; }

    .type-btn { padding: 12px 4px; border: 2px solid #e2e8f0; border-radius: 12px; font-weight: bold; font-size: 0.9rem; background: white; width: 100%; color: #64748b; }
    .type-btn.active { border-color: #3b82f6; background-color: #eff6ff; color: #1d4ed8; border-width: 3px; }

    .tag-checkbox { display: none; }
    .tag-label { padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 0.8rem; font-weight: bold; color: #64748b; cursor: pointer; }
    .tag-checkbox:checked + .tag-label { background-color: #3b82f6; color: white; border-color: #3b82f6; }

    .hist-detail { display: none; }
    .hist-detail.open { display: block; }

    #page-main, #page-history, #page-share { padding-bottom: 160px; }
    #page-share { background-color: #f1f5f9; min-height: 100vh; padding-left: 12px; padding-right: 12px; }
    .result-card { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; border-radius: 32px; padding: 22px 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.4); width: 100%; }
    .top3-box { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 14px; margin-top: 10px; }
  </style>
</head>

<body class="max-w-md mx-auto p-4">

  <!-- âœ… æ›´æ–°é€šçŸ¥ãƒãƒ¼ï¼šheaderã®å¤–ã«ç½®ãï¼ˆè¡¨ç¤ºãŒå®‰å®šã™ã‚‹ï¼‰ -->
  <div id="update-bar" class="hidden fixed top-2 left-1/2 -translate-x-1/2 z-[60] bg-slate-900 text-white px-4 py-3 rounded-2xl shadow-xl flex items-center gap-3">
    <div class="text-sm font-bold">æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™</div>
    <button id="update-btn" class="bg-blue-500 px-3 py-1 rounded-xl font-black">æ›´æ–°</button>
  </div>

  <header class="flex justify-between items-center mb-4">
    <div>
      <h1 class="text-xl font-bold text-gray-800">ğŸš• TAXIæ—¥å ± PRO</h1>
      <p id="clock" class="text-[10px] text-gray-400 font-mono"></p>
    </div>
    <button onclick="openSettings()" class="p-2 bg-gray-100 rounded-full text-gray-400 text-xl text-center">âš™ï¸</button>
  </header>

  <div id="page-main">
    <div id="type-selector-container" class="hidden grid grid-cols-3 gap-2 mb-4">
      <button onclick="setType('ä¸€èˆ¬')" class="type-btn" id="type-ä¸€èˆ¬">ğŸš• ä¸€èˆ¬</button>
      <button onclick="setType('ç„¡ç·š')" class="type-btn" id="type-ç„¡ç·š">ğŸ“¡ ç„¡ç·š</button>
      <button onclick="setType('ä»˜å¾…')" class="type-btn" id="type-ä»˜å¾…">ğŸš‰ ä»˜å¾…</button>
    </div>

    <div id="main-controls" class="mb-4"></div>

    <div class="status-container shadow-lg">
      <div class="status-item" style="width: 20%;"><span class="text-[9px] text-gray-400">å›æ•°</span><span class="text-xl font-bold" id="dash-count">0</span></div>
      <div class="status-item bg-gray-800" style="width: 55%;">
        <span class="text-[9px] text-emerald-400 font-bold uppercase">ç¨æŠœå–¶å</span>
        <span class="text-2xl font-bold text-yellow-400" id="dash-net">0</span>

        <!-- âœ… ã“ã“ã¯ã€Œé«˜é€ŸæŠœãï¼ˆç¨è¾¼ï¼‰ã€ã‚’è¡¨ç¤ºã—ãŸã„ã®ã§ã€æ–‡è¨€ã‚‚åˆ†ã‹ã‚Šã‚„ã™ãå¤‰æ›´ -->
        <span class="text-[9px] text-gray-400">ç¨è¾¼å–¶å: Â¥<span id="dash-sales">0</span></span>
      </div>
      <div class="status-item" style="width: 25%; border-right: none;"><span class="text-[9px] text-gray-400">å–¶æ¥­è·é›¢</span>
        <div class="flex items-baseline"><span class="text-xl font-bold" id="dash-km">0.0</span><span class="text-[9px] ml-0.5 text-gray-400 font-bold">km</span></div>
      </div>
    </div>

    <div id="end-shift-container" class="hidden text-center mb-6">
      <button onclick="switchPage('share')" class="text-red-500 font-black text-lg underline decoration-2 underline-offset-4">å‹¤å‹™çµ‚äº†ï¼ˆå¸°åº«ï¼‰</button>
    </div>

    <div id="input-form" class="hidden card">
      <h2 id="form-title" class="text-center font-bold text-gray-700 mb-4 text-lg">æ¸…ç®—å…¥åŠ›</h2>
      <div class="space-y-4">
        <div id="route-display-area" class="hidden bg-blue-50/50 rounded-xl p-4 border border-blue-100 text-center mb-4">
          <div id="start-p-display" class="text-sm text-gray-700 font-bold leading-tight"></div>
          <div class="text-blue-400 my-1 font-bold text-lg leading-none">â†“</div>
          <div id="end-p-display" class="text-base text-blue-800 font-black leading-tight"></div>
        </div>

        <div id="tag-container" class="flex flex-wrap gap-2 justify-center"></div>

        <div id="fare-section" class="hidden space-y-4 pt-2">
          <div class="flex items-center justify-between">
            <label class="text-sm font-bold text-gray-600">æ”¯æ‰•åˆè¨ˆï¼ˆç¨è¾¼ï¼‰</label>
            <input type="number" id="inp-fare" class="w-32 p-2 border rounded-xl text-xl font-bold text-right text-blue-700 focus:outline-none" inputmode="numeric">
          </div>
          <div class="flex items-center justify-between">
            <label class="text-sm font-bold text-red-500">ï¼ˆã†ã¡é«˜é€Ÿä»£ï¼‰</label>
            <input type="number" id="inp-hiway" class="w-32 p-2 border rounded-xl text-lg font-bold text-right text-red-500 focus:outline-none" inputmode="numeric" placeholder="0">
          </div>
        </div>

        <button onclick="handleMainAction()" id="action-btn" class="btn-main bg-blue-600 text-white shadow-lg">è¨˜éŒ²ã‚’ä¿å­˜</button>

        <div id="extra-fields" class="space-y-4">
          <div id="form-memo-area" class="hidden">
            <textarea id="inp-memo" class="w-full p-3 border border-gray-200 rounded-xl text-sm h-24 focus:outline-none" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
          </div>
          <div id="form-dist-area" class="hidden flex justify-between items-end border-b border-gray-100 pb-2">
            <span class="text-sm font-bold text-gray-500 pb-1">å–¶æ¥­è·é›¢</span>
            <div class="flex items-baseline">
              <input type="number" id="inp-dist" class="text-right text-2xl font-bold text-gray-800 w-32 focus:outline-none bg-transparent" inputmode="decimal" placeholder="0.0">
              <span class="text-lg font-bold text-gray-400 ml-1">km</span>
            </div>
          </div>
        </div>

        <button onclick="cancelInput()" class="w-full text-gray-400 text-xs py-2 text-center underline">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <div id="main-current-logs" class="mt-4"></div>
  </div>

  <div id="page-history" class="hidden">
    <h2 class="text-xl font-bold mb-4 border-l-4 border-blue-500 pl-3">å‹¤å‹™å±¥æ­´</h2>
    <div class="mb-4 relative">
      <input type="text" id="history-search" oninput="renderHistory()" placeholder="ğŸ” ã‚¿ã‚°ãƒ»åœ°ç‚¹ãƒ»æ—¥ä»˜ã§æ¤œç´¢..." class="w-full p-4 pr-12 border rounded-2xl text-sm focus:outline-none shadow-sm bg-white">
      <button id="search-clear-btn" onclick="clearSearch()" class="hidden absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 text-xl font-bold p-1">âœ•</button>
    </div>
    <div id="period-total-card" class="mb-4"></div>
    <div id="history-content" class="space-y-3"></div>
  </div>

  <div id="page-share" class="hidden">
    <div class="result-card">
      <div class="flex justify-between items-start mb-4">
        <div>
          <p class="text-yellow-400 font-black tracking-widest text-lg">DAILY RESULT</p>
          <p id="share-date-mode" class="text-[10px] text-gray-400 font-bold uppercase mt-0.5"></p>
        </div>
        <span class="text-3xl">ğŸš•</span>
      </div>

      <div class="text-center mb-4">
        <p class="text-[9px] text-emerald-400 font-bold uppercase tracking-widest mb-1">Net Sales (ç¨æŠœå–¶å)</p>
        <div class="flex justify-center items-center">
          <span class="text-3xl font-black text-white mr-1">Â¥</span>
          <span class="text-5xl font-black text-white leading-none tracking-tight" id="share-net">0</span>
        </div>
        <div class="flex justify-center gap-6 mt-4 text-[10px] font-bold text-gray-500 border-t border-white/5 pt-3">
          <div class="bg-white/5 px-3 py-1 rounded-full">COUNT: <span id="share-count" class="text-white text-xs">0</span></div>
          <div id="share-dist-box" class="bg-white/5 px-3 py-1 rounded-full text-white">KM: <span id="share-km" class="text-white text-xs">0.0</span></div>
        </div>
      </div>

      <div id="share-top3" class="top3-box"></div>
      <p class="text-center text-[8px] text-gray-600 mt-6 italic tracking-[0.2em]">RECORDED BY TAXIæ—¥å ± PRO</p>
    </div>

    <div class="mt-8 px-2 text-center">
      <p class="text-xl text-blue-700 font-black mb-4 italic drop-shadow-sm">ğŸ“¸ ã“ã®ç”»é¢ã‚’ã‚¹ã‚¯ã‚·ãƒ§ã—ã¦ä¿å­˜ï¼</p>
      <button onclick="executeFinish()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black shadow-xl text-lg mb-4">ã“ã®å†…å®¹ã§å‹¤å‹™çµ‚äº†ã‚’ç¢ºå®š</button>
      <button onclick="switchPage('main')" class="w-full text-slate-400 text-xs py-2 underline">ä¹—å‹™ç”»é¢ã«æˆ»ã‚‹</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" id="nav-main" onclick="switchPage('main')"><span class="nav-icon">ğŸš•</span>ä¹—å‹™</div>
    <div class="nav-item" id="nav-history" onclick="switchPage('history')"><span class="nav-icon">ğŸ“–</span>å±¥æ­´</div>
    <div class="nav-item" id="nav-share" onclick="switchPage('share')"><span class="nav-icon">âœ¨</span>ã‚·ã‚§ã‚¢</div>
  </nav>

  <div id="modal-container" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
    <div id="modal-content" class="bg-white rounded-3xl w-full max-sm overflow-hidden shadow-2xl"></div>
  </div>

  <!-- âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã¯â€œå›ºå®šâ€ã«ã™ã‚‹ï¼ˆiOS/PWAã§å®‰å®šï¼‰ -->
  <input type="file" id="csv-file-input" class="hidden" accept=".csv,text/csv" />

  <script>
    // ===== Storage Keys =====
    const DB_KEY = 'TAXI_PRO_FIXED_STORAGE_V1';
    const SET_KEY = 'TAXI_PRO_SETTINGS_FIXED';
    const TAG_LIST = ['ç—…é™¢', 'é§…', 'ãƒ›ãƒ†ãƒ«', 'ç©ºæ¸¯', 'ä¸‡å', 'æŒ‡å'];

    // ===== State =====
    let state = {
      status: 'OFF',
      currentShift: null,
      shifts: [],
      editingIndex: -1,
      tempRide: { type: 'ä¸€èˆ¬', tags: [], startPlace: '', endPlace: '', memo: '' },
      settings: { mode: 'éš”æ—¥å‹¤å‹™', showMemo: true, showDist: true, closingDay: 19 }
    };

    // ===== Init =====
    window.onload = () => {
      try {
        const d = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
        state.shifts = d.shifts || [];
        state.currentShift = d.currentShift || null;
        state.status = d.status || 'OFF';
        state.settings = JSON.parse(localStorage.getItem(SET_KEY) || JSON.stringify(state.settings));
        startClock();
        render();
      } catch (e) { console.error(e); }
    };

    // ===== Utils =====
    function getNet(val) {
      if (!val || val <= 0) return 0;
      const taxEx = val / 1.1;
      return Math.ceil(taxEx / 10) * 10;
    }

    function save() {
      localStorage.setItem(DB_KEY, JSON.stringify({ shifts: state.shifts, currentShift: state.currentShift, status: state.status }));
    }

    function startClock() {
      const el = document.getElementById('clock');
      const u = () => {
        if (el) el.innerText = new Date().toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', weekday:'short', hour:'2-digit', minute:'2-digit', second:'2-digit' });
      };
      u();
      setInterval(u, 1000);
    }

    function setType(t) {
      state.tempRide.type = t;
      ['ä¸€èˆ¬', 'ç„¡ç·š', 'ä»˜å¾…'].forEach(type => {
        const b = document.getElementById(`type-${type}`);
        if (b) b.className = `type-btn ${t === type ? 'active' : ''}`;
      });
    }

    function applyDisplaySettings() {
      const m = document.getElementById('form-memo-area');
      const d = document.getElementById('form-dist-area');
      if (m) state.settings.showMemo ? m.classList.remove('hidden') : m.classList.add('hidden');
      if (d) state.settings.showDist ? d.classList.remove('hidden') : d.classList.add('hidden');
    }

    async function getGPS() {
      return new Promise(r => {
        if (!navigator.geolocation) return r("åœ°ç‚¹ä¸æ˜");
        navigator.geolocation.getCurrentPosition(async p => {
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}&accept-language=ja`);
            const j = await res.json();
            const a = j.address || {};
            const cityPart = a.city || a.ward || a.town || a.village || a.county || "";
            const townPart = a.quarter || a.suburb || a.neighbourhood || a.city_district || "";
            r((cityPart + townPart) || "å–å¾—åœ°ç‚¹");
          } catch {
            r("å–å¾—ã‚¨ãƒ©ãƒ¼");
          }
        }, () => r("GPSãªã—"), { enableHighAccuracy: true });
      });
    }

    // ===== Render =====
    function render() {
      const ctrl = document.getElementById('main-controls');
      const form = document.getElementById('input-form');
      const fareSec = document.getElementById('fare-section');
      const typeBox = document.getElementById('type-selector-container');
      const endBtnBox = document.getElementById('end-shift-container');
      const routeBox = document.getElementById('route-display-area');
      if (!ctrl) return;

      ctrl.innerHTML = '';

      if (state.status === 'OFF') {
        ctrl.innerHTML = `<button onclick="startShift()" class="btn-main bg-emerald-600 text-white shadow-emerald-100">å‹¤å‹™é–‹å§‹ï¼ˆå‡ºåº«ï¼‰</button>`;
        form.classList.add('hidden');
        typeBox.classList.add('hidden');
        endBtnBox.classList.add('hidden');
      } else {
        typeBox.classList.remove('hidden');
        setType(state.tempRide.type);

        if (state.status === 'WAITING') {
          ctrl.innerHTML = `<button onclick="startRide()" class="btn-main bg-blue-600 text-white shadow-blue-100">ä¹—è»Šé–‹å§‹</button>`;
          form.classList.add('hidden');
          endBtnBox.classList.remove('hidden');
          routeBox.classList.add('hidden');
          fareSec.classList.add('hidden');

        } else if (state.status === 'RIDING') {
          form.classList.remove('hidden');
          fareSec.classList.add('hidden');
          document.getElementById('form-title').innerText = `å®Ÿè»Šè©³ç´° [${state.tempRide.type}]`;
          document.getElementById('action-btn').innerText = "ãŠå®¢æ§˜é™è»Šï¼ˆæ¸…ç®—ã¸ï¼‰";
          ctrl.innerHTML = `<div class="p-2 text-red-500 font-bold animate-pulse text-center">è³ƒèµ°ä¸­...</div>`;
          endBtnBox.classList.add('hidden');
          renderTags();
          applyDisplaySettings();

        } else if (state.status === 'FINISHING') {
          form.classList.remove('hidden');
          routeBox.classList.remove('hidden');
          fareSec.classList.remove('hidden');
          document.getElementById('form-title').innerText = "æ¸…ç®—å…¥åŠ›";
          document.getElementById('start-p-display').innerText = state.tempRide.startPlace;
          document.getElementById('end-p-display').innerText = state.tempRide.endPlace || "å–å¾—ä¸­...";
          document.getElementById('action-btn').innerText = "è¨˜éŒ²ã‚’ä¿å­˜";
          renderTags();
          applyDisplaySettings();
        }
      }

      updateDash();
      renderCurrentLogs();
      save();
    }

    function renderTags() {
      const container = document.getElementById('tag-container');
      if (!container) return;
      container.innerHTML = TAG_LIST.map(tag =>
        `<input type="checkbox" id="tag-${tag}" class="tag-checkbox" onchange="toggleTag('${tag}')" ${state.tempRide.tags.includes(tag)?'checked':''}>
         <label for="tag-${tag}" class="tag-label">${tag}</label>`
      ).join('');
    }

    function toggleTag(t) {
      if (state.tempRide.tags.includes(t)) state.tempRide.tags = state.tempRide.tags.filter(x => x !== t);
      else state.tempRide.tags.push(t);
    }

    function resetInputs() {
      document.querySelectorAll('#inp-fare, #inp-hiway, #inp-dist, #inp-memo').forEach(el => el.value = '');
    }

    async function startRide() {
      state.status = 'RIDING';
      state.editingIndex = -1;
      state.tempRide = { type: state.tempRide.type || 'ä¸€èˆ¬', tags: [], startPlace: 'å–å¾—ä¸­...', endPlace: '', memo: '' };
      resetInputs();
      render();
      state.tempRide.startPlace = await getGPS();
      render();
    }

    async function handleMainAction() {
      if (state.status === 'RIDING') {
        state.tempRide.memo = document.getElementById('inp-memo').value;
        state.status = 'FINISHING';
        render();
        state.tempRide.endPlace = await getGPS();
        render();
        return;
      }

      if (!state.currentShift) return;

      // å…¥åŠ›ï¼ˆæ”¯æ‰•åˆè¨ˆï¼é«˜é€Ÿè¾¼ã¿ï¼‰
      const f = Number(parseInt(document.getElementById('inp-fare').value) || 0);
      const h = Number(parseInt(document.getElementById('inp-hiway').value) || 0);

      // ä¿å­˜ï¼ˆfareã¯é«˜é€ŸæŠœãã®ç¨è¾¼å–¶åã€hiwayã¯é«˜é€Ÿä»£ï¼‰
      const d = {
        ...state.tempRide,
        fare: Math.max(0, f - h), // âœ… ç¨è¾¼å–¶åï¼ˆé«˜é€ŸæŠœãï¼‰
        hiway: Math.max(0, h),    // âœ… é«˜é€Ÿä»£
        dist: Number(parseFloat(document.getElementById('inp-dist').value) || 0),
        memo: document.getElementById('inp-memo').value,
        time: state.editingIndex > -1 ? state.currentShift.rides[state.editingIndex].time : new Date().toLocaleTimeString('ja-JP', {hour:'2-digit',minute:'2-digit'})
      };

      if (state.editingIndex > -1) state.currentShift.rides[state.editingIndex] = d;
      else state.currentShift.rides.push(d);

      state.status = 'WAITING';
      state.editingIndex = -1;
      state.tempRide.type = 'ä¸€èˆ¬';
      resetInputs();
      render();
    }

    function updateDash() {
  const a = state.currentShift || { rides: [] };

  // é«˜é€ŸæŠœãï¼ˆç¨è¾¼ï¼‰åˆè¨ˆï¼ˆé‹è³ƒéƒ¨åˆ†ï¼‰
  const tf = a.rides.reduce((v, r) => v + (Number(r.fare) || 0), 0);

  // é«˜é€Ÿä»£åˆè¨ˆï¼ˆå¿…è¦ãªã‚‰ä¿æŒï¼‰
  const th = a.rides.reduce((v, r) => v + (Number(r.hiway) || 0), 0);

  // æ”¯æ‰•ç·é¡ï¼ˆç¨è¾¼ï¼‰ï¼é‹è³ƒ + é«˜é€Ÿï¼ˆâ€»ä»Šå›ã¯è¡¨ç¤ºã«ä½¿ã‚ãªã„ï¼‰
  // const paidTotal = tf + th;

  document.getElementById('dash-count').innerText = a.rides.length;

  // ç¨æŠœå–¶åï¼ˆé«˜é€ŸæŠœãç¨è¾¼ã‹ã‚‰ç¨æŠœè¨ˆç®—ï¼‰
  document.getElementById('dash-net').innerText = getNet(tf).toLocaleString();

  // âœ… ç¨è¾¼å–¶åï¼ˆé«˜é€ŸæŠœãï¼‰ï¼tf â†’ 88,000 ãŒå‡ºã‚‹
  document.getElementById('dash-sales').innerText = tf.toLocaleString();

  document.getElementById('dash-km').innerText =
    a.rides.reduce((v, r) => v + (Number(r.dist) || 0), 0).toFixed(1);
}


    function renderCurrentLogs() {
      const el = document.getElementById('main-current-logs');
      if (!el || !state.currentShift) return;

      el.innerHTML = `<h3 class="text-[10px] text-gray-400 text-center uppercase tracking-widest mb-2 mt-4">Current Logs</h3>`;

      [...state.currentShift.rides].reverse().forEach((r, i) => {
        const idx = state.currentShift.rides.length - 1 - i;

        // âœ… ãƒ­ã‚°è¡¨ç¤ºã¯ã€Œç¨è¾¼å–¶åï¼ˆé«˜é€ŸæŠœãï¼‰ã€ï¼ r.fare ã‚’è¡¨ç¤ºï¼ˆã“ã“ãŒ 88,000 ã«ãªã‚‹ï¼‰
        const shown = (Number(r.fare) || 0).toLocaleString();

        el.innerHTML += `
          <div class="bg-white p-3 rounded-xl border mb-2 flex justify-between items-center text-sm shadow-sm">
            <div>
              <b>${r.time}</b> Â¥${shown} [${r.type}]<br>
              <span class="text-[9px] text-gray-400">${r.endPlace}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="editRide(${idx})" class="text-blue-500 text-[10px] font-bold">ç·¨é›†</button>
              <button onclick="deleteRide(${idx})" class="text-red-400 text-[10px] font-bold">å‰Šé™¤</button>
            </div>
          </div>`;
      });
    }

    function editRide(idx) {
      const r = state.currentShift.rides[idx];
      state.editingIndex = idx;
      state.tempRide = { ...r };
      state.status = 'FINISHING';
      render();

      // å…¥åŠ›æ¬„ã¯ã€Œæ”¯æ‰•åˆè¨ˆï¼ˆç¨è¾¼ï¼‰ã€ãªã®ã§ã€ä¿å­˜å€¤ï¼ˆfare+hiwayï¼‰ã‚’æˆ»ã™
      document.getElementById('inp-fare').value = (Number(r.fare) || 0) + (Number(r.hiway) || 0);
      document.getElementById('inp-hiway').value = Number(r.hiway) || 0;
      document.getElementById('inp-dist').value = Number(r.dist) || 0;
      document.getElementById('inp-memo').value = r.memo || '';
    }

    function deleteRide(idx) {
      if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      state.currentShift.rides.splice(idx, 1);
      render();
    }

    function cancelInput() {
      if (!confirm("ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ")) return;
      state.status = 'WAITING';
      state.editingIndex = -1;
      resetInputs();
      render();
    }

    function startShift() {
      state.currentShift = { date: new Date().toLocaleDateString('ja-JP'), rides: [] };
      state.status = 'WAITING';
      state.tempRide.type = 'ä¸€èˆ¬';
      render();
    }

    function executeFinish() {
      if (!state.currentShift) return;
      state.shifts.unshift(JSON.parse(JSON.stringify(state.currentShift)));
      state.currentShift = null;
      state.status = 'OFF';
      save();
      render();
      renderShare();
      openModal(`
        <div class="p-8 text-center">
          <div class="text-6xl mb-4">ğŸ†</div>
          <p class="font-black text-xl mb-2 text-gray-800">å¸°åº«å®Œäº†ï¼</p>
          <p class="text-gray-500 text-sm mb-8 leading-relaxed">æœ¬æ—¥ã®å‹¤å‹™ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚</p>
          <button onclick="closeModal(); switchPage('main');" class="w-full py-4 rounded-2xl bg-blue-600 text-white font-black shadow-lg text-lg">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</button>
        </div>`);
    }

    function switchPage(p) {
      ['main','history','share'].forEach(id => {
        document.getElementById('page-'+id).classList.toggle('hidden', id !== p);
        document.getElementById('nav-'+id).classList.toggle('active', id === p);
      });
      if (p === 'history') renderHistory();
      if (p === 'share') renderShare();
    }

    function clearSearch() {
      const input = document.getElementById('history-search');
      input.value = '';
      renderHistory();
      input.focus();
    }

    function calculatePeriodTotal() {
      const closingDay = parseInt(state.settings.closingDay) || 19;
      const now = new Date();
      let start, end;
      if (now.getDate() > closingDay) {
        start = new Date(now.getFullYear(), now.getMonth(), closingDay + 1);
        end = new Date(now.getFullYear(), now.getMonth() + 1, closingDay);
      } else {
        start = new Date(now.getFullYear(), now.getMonth() - 1, closingDay + 1);
        end = new Date(now.getFullYear(), now.getMonth(), closingDay);
      }

      let netTotal = 0, grossTotal = 0;
      const allShifts = state.currentShift ? [state.currentShift, ...state.shifts] : state.shifts;

      allShifts.forEach(s => {
        const sDate = new Date(s.date);
        if (sDate >= start && sDate <= end) {
          s.rides.forEach(r => {
            netTotal += (Number(r.fare) || 0); // fareã¯é«˜é€ŸæŠœãã®ç¨è¾¼å–¶å
            grossTotal += ((Number(r.fare) || 0) + (Number(r.hiway) || 0)); // å‚è€ƒï¼šé«˜é€Ÿè¾¼ã¿
          });
        }
      });

      return `
        <div class="card bg-slate-800 text-white shadow-md">
          <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">çµ¦ä¸æœŸé–“ç´¯è¨ˆ (${(start.getMonth()+1)}/${start.getDate()} ã€œ)</div>
          <div class="flex justify-between items-end">
            <div>
              <span class="text-[9px] text-emerald-400 font-bold block">ç¨æŠœå–¶åç´¯è¨ˆ</span>
              <span class="text-2xl font-black text-yellow-400">Â¥${getNet(netTotal).toLocaleString()}</span>
            </div>
            <div class="text-right">
              <span class="text-[9px] text-slate-400 block uppercase">ç¨è¾¼åˆè¨ˆ</span>
              <span class="text-sm font-bold">Â¥${grossTotal.toLocaleString()}</span>
            </div>
          </div>
        </div>`;
    }

    function renderHistory() {
      const el = document.getElementById('history-content');
      const input = document.getElementById('history-search');
      const clearBtn = document.getElementById('search-clear-btn');
      const totalEl = document.getElementById('period-total-card');
      if (!el) return;

      const query = (input.value || '').toLowerCase();
      el.innerHTML = '';
      if (query !== '') clearBtn.classList.remove('hidden'); else clearBtn.classList.add('hidden');
      if (totalEl) totalEl.innerHTML = calculatePeriodTotal();

      state.shifts.forEach((s, idx) => {
        if (query !== '' && !s.date.includes(query) && !s.rides.some(r => (r.endPlace||'').toLowerCase().includes(query) || (r.type||'').toLowerCase().includes(query))) return;

        const dailyTotalFare = s.rides.reduce((v, r) => v + (Number(r.fare) || 0), 0);   // é«˜é€ŸæŠœãï¼ˆç¨è¾¼ï¼‰
        const dailyTotalHiway = s.rides.reduce((v, r) => v + (Number(r.hiway) || 0), 0); // é«˜é€Ÿ
        const dailyNet = getNet(dailyTotalFare);
        const dailyGross = dailyTotalFare + dailyTotalHiway; // å‚è€ƒï¼šé«˜é€Ÿè¾¼ã¿

        el.innerHTML += `
          <div class="card p-0 overflow-hidden shadow-sm">
            <div class="p-4 bg-white flex justify-between items-center font-bold" onclick="toggleHist(${idx})">
              <span>${s.date} ${s.rides.length}ä»¶</span>
              <div class="text-right">
                <span class="text-blue-600 block text-lg leading-tight">Â¥${dailyNet.toLocaleString()}</span>
                <span class="text-gray-400 text-[10px] font-normal">ç¨è¾¼ Â¥${dailyGross.toLocaleString()}</span>
              </div>
            </div>
            <div id="hist-det-${idx}" class="hist-detail p-4 border-t bg-gray-50">
              ${s.rides.map(r => {
                // âœ… æ˜ç´°ã¯ã€Œç¨è¾¼å–¶åï¼ˆé«˜é€ŸæŠœãï¼‰ã€ã‚’è¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰ã“ã“ã‚‚é«˜é€Ÿè¾¼ã¿ã«æˆ»ã›ã¾ã™ï¼‰
                const shown = (Number(r.fare) || 0).toLocaleString();
                return `
                <div class="py-2 border-b last:border-0 border-gray-200">
                  <div class="flex justify-between font-bold text-[11.5px] mb-0.5">
                    <span>${r.time} [${r.type}] ${r.endPlace}</span>
                    <span>Â¥${shown}</span>
                  </div>
                </div>`;
              }).join('')}
            </div>
          </div>`;
      });
    }

    function toggleHist(idx) { document.getElementById(`hist-det-${idx}`).classList.toggle('open'); }

    function renderShare() {
      const sn = document.getElementById('share-net');
      if (!sn) return;

      if (!state.currentShift) {
        document.getElementById('share-date-mode').innerText = "æœªå‡ºåº«";
        sn.innerText = "0";
        document.getElementById('share-count').innerText = "0";
        document.getElementById('share-km').innerText = "0.0";
        document.getElementById('share-top3').innerHTML = '<p class="text-center text-gray-500 text-[10px] py-4 uppercase">No Data</p>';
        return;
      }

      const a = state.currentShift;
      const tf = a.rides.reduce((v, r) => v + (Number(r.fare) || 0), 0); // é«˜é€ŸæŠœãï¼ˆç¨è¾¼ï¼‰
      document.getElementById('share-date-mode').innerText = `${a.date} / ${state.settings.mode}`;
      sn.innerText = getNet(tf).toLocaleString();
      document.getElementById('share-count').innerText = a.rides.length;
      document.getElementById('share-km').innerText = a.rides.reduce((v, r) => v + (Number(r.dist) || 0), 0).toFixed(1);
      document.getElementById('share-dist-box').style.display = state.settings.showDist ? 'block' : 'none';

      const top3 = [...a.rides].sort((x, y) => (Number(y.fare) || 0) - (Number(x.fare) || 0)).slice(0, 3);
      const icons = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
      document.getElementById('share-top3').innerHTML = top3.map((r, i) => `
        <div class="flex justify-between items-center py-4 border-b border-white/10 last:border-0">
          <div class="flex items-center gap-3 overflow-hidden">
            <span class="text-4xl flex-shrink-0">${icons[i]}</span>
            <div class="text-left overflow-hidden">
              <p class="text-[8px] text-gray-500 uppercase font-bold">${r.time} [${r.type}]</p>
              <p class="text-[11px] text-white font-bold truncate">${r.endPlace || 'åœ°ç‚¹ä¸æ˜'}</p>
            </div>
          </div>
          <span class="text-2xl font-black text-white whitespace-nowrap ml-2">Â¥${getNet(Number(r.fare) || 0).toLocaleString()}</span>
        </div>`).join('') || '<p class="text-center text-[10px] py-4 uppercase">No Data Recorded</p>';
    }

    // ===== Settings Modal =====
    function openSettings() {
      document.getElementById('modal-content').innerHTML = `
        <div class="p-6">
          <h2 class="font-bold text-center text-lg mb-6 text-gray-800">ã‚¢ãƒ—ãƒªè¨­å®š</h2>

          <div class="space-y-4">
            <div>
              <label class="block text-xs font-bold text-gray-400 mb-2 tracking-widest uppercase">å‹¤å‹™å½¢æ…‹</label>
              <select id="s-mode" class="w-full p-3 bg-gray-50 border-none rounded-2xl font-bold">
                ${['æ—¥å‹¤', 'å¤œå‹¤', 'éš”æ—¥å‹¤å‹™'].map(m => `<option ${state.settings.mode === m ? 'selected' : ''}>${m}</option>`).join('')}
              </select>
            </div>

            <div>
              <label class="block text-xs font-bold text-gray-400 mb-2 tracking-widest uppercase">çµ¦ä¸ç· ã‚æ—¥</label>
              <input type="number" id="s-closing" value="${state.settings.closingDay}" class="w-full p-3 bg-gray-50 border-none rounded-2xl font-bold text-center">
            </div>

            <div class="flex justify-between items-center">
              <span class="text-sm font-bold text-gray-700">ãƒ¡ãƒ¢æ¬„ã‚’è¡¨ç¤º</span>
              <label class="flex items-center">
                <input type="checkbox" id="s-memo" class="hidden" ${state.settings.showMemo ? 'checked' : ''}>
                <div class="toggle-switch"></div>
              </label>
            </div>

            <div class="flex justify-between items-center border-b border-gray-100 pb-2">
              <span class="text-sm font-bold text-gray-700">å–¶æ¥­è·é›¢ã‚’è¡¨ç¤º</span>
              <label class="flex items-center">
                <input type="checkbox" id="s-dist" class="hidden" ${state.settings.showDist ? 'checked' : ''}>
                <div class="toggle-switch"></div>
              </label>
            </div>

            <div class="pt-2">
              <p class="text-[10px] font-bold text-gray-400 mb-2 tracking-widest uppercase">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</p>
              <button onclick="saveSet()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg mb-2 text-lg">è¨­å®šã‚’ä¿å­˜</button>
              <button onclick="exportCSV()" class="w-full bg-emerald-500 text-white py-3 rounded-2xl font-bold mb-2">CSVã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
              <button onclick="importCSV()" class="w-full bg-amber-500 text-white py-3 rounded-2xl font-bold mb-4 shadow-sm">CSVã‚’èª­ã¿è¾¼ã‚€ï¼ˆå¾©å…ƒ/è¿½è¨˜ï¼‰</button>
            </div>

            <div class="border-t border-gray-100 pt-4">
              <button onclick="forceUpdate()" class="w-full text-blue-500 text-xs py-2 underline">ã‚¢ãƒ—ãƒªã‚’å¼·åˆ¶æ›´æ–°ï¼ˆæœ€æ–°ç‰ˆã‚’èª­è¾¼ï¼‰</button>
              <button onclick="clearSys()" class="w-full text-red-400 text-[10px] mt-2 font-bold underline">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
            </div>

            <button onclick="closeModal()" class="w-full text-gray-400 text-xs mt-2 text-center underline">é–‰ã˜ã‚‹</button>
          </div>
        </div>`;
      document.getElementById('modal-container').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }

    function saveSet() {
      state.settings = {
        mode: document.getElementById('s-mode').value,
        closingDay: parseInt(document.getElementById('s-closing').value) || 19,
        showMemo: document.getElementById('s-memo').checked,
        showDist: document.getElementById('s-dist').checked
      };
      localStorage.setItem(SET_KEY, JSON.stringify(state.settings));
      closeModal();
      render();
    }

    function forceUpdate() {
      if (!confirm("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’èª­ã¿è¾¼ã¿ç›´ã—ã¾ã™ã€‚\nå…¥åŠ›ä¸­ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä¿å­˜ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")) return;
      location.reload();
    }

    function clearSys() {
      if (!confirm("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆå»ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      localStorage.clear();
      location.reload();
    }

    // ===== CSV Export =====
    function escapeCSV(v) {
      const s = String(v ?? '');
      if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
      return s;
    }

    function exportCSV() {
      let c = "æ—¥ä»˜,æ™‚åˆ»,åŒºåˆ†,ç¨è¾¼,é«˜é€Ÿ,ç¨æŠœ,è·é›¢,å®Ÿè»Š,é™è»Š,ãƒ¡ãƒ¢\n";
      state.shifts.forEach(s => {
        s.rides.forEach(r => {
          const gross = (Number(r.fare) || 0) + (Number(r.hiway) || 0); // é«˜é€Ÿè¾¼ã¿ã®æ”¯æ‰•åˆè¨ˆ
          c += [
            escapeCSV(s.date),
            escapeCSV(r.time),
            escapeCSV(r.type),
            escapeCSV(gross),
            escapeCSV(Number(r.hiway) || 0),
            escapeCSV(getNet(Number(r.fare) || 0)),
            escapeCSV(Number(r.dist) || 0),
            escapeCSV(r.startPlace),
            escapeCSV(r.endPlace),
            escapeCSV(r.memo)
          ].join(',') + "\n";
        });
      });

      const b = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), c], { type: 'text/csv' });
      const l = document.createElement("a");
      l.href = URL.createObjectURL(b);

      const now = new Date();
      const dateStr = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
      l.download = `taxi_history_${dateStr}.csv`;
      l.click();
    }

    // ===== CSV Import (Restore or Append) =====
    function importCSV() {
      const input = document.getElementById('csv-file-input');
      input.value = '';
      input.onchange = async () => {
        const file = input.files && input.files[0];
        if (!file) return;

        const mode = confirm("èª­ã¿è¾¼ã¿æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚\n\nOKï¼šè¿½è¨˜ï¼ˆä»Šã®å±¥æ­´ã«è¿½åŠ ï¼‰\nã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼šä¸Šæ›¸ãå¾©å…ƒï¼ˆå±¥æ­´ã‚’å…¥ã‚Œæ›¿ãˆï¼‰")
          ? 'append'
          : 'overwrite';

        const text = await file.text();
        const imported = parseTaxiCSV(text);

        if (imported.length === 0) {
          alert("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
          return;
        }

        if (mode === 'overwrite') {
          if (!confirm("ä¸Šæ›¸ãå¾©å…ƒã—ã¾ã™ã€‚\nç¾åœ¨ã®å±¥æ­´ã¯ç½®ãæ›ã‚ã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
          state.shifts = imported;
        } else {
          mergeImportedShifts(imported);
        }

        save();
        render();
        alert(`èª­ã¿è¾¼ã¿å®Œäº†ï¼š${imported.length}æ—¥åˆ†ï¼ˆ${mode === 'append' ? 'è¿½è¨˜' : 'ä¸Šæ›¸ã'}ï¼‰`);
        closeModal();
      };
      input.click();
    }

    // CSVãƒ‘ãƒ¼ã‚¹ï¼ˆå¼•ç”¨ç¬¦å¯¾å¿œã®ç°¡æ˜“ç‰ˆï¼‰
    function parseCSVLine(line) {
      const out = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (inQuotes) {
          if (ch === '"') {
            if (line[i + 1] === '"') { cur += '"'; i++; }
            else inQuotes = false;
          } else {
            cur += ch;
          }
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { out.push(cur); cur = ''; }
          else cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function parseTaxiCSV(text) {
      text = text.replace(/^\uFEFF/, '');
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
      if (lines.length <= 1) return [];

      const header = lines[0];
      if (!header.includes('æ—¥ä»˜') || !header.includes('æ™‚åˆ»')) return [];

      const map = new Map();

      for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        if (cols.length < 10) continue;

        const date = (cols[0] || '').trim();
        const time = (cols[1] || '').trim();
        const type = (cols[2] || 'ä¸€èˆ¬').trim();

        const gross = Number(parseInt(cols[3]) || 0); // æ”¯æ‰•åˆè¨ˆï¼ˆé«˜é€Ÿè¾¼ã¿ï¼‰
        const hiway = Number(parseInt(cols[4]) || 0); // é«˜é€Ÿ
        const dist = Number(parseFloat(cols[6]) || 0);

        const startP = (cols[7] || '').trim();
        const endP = (cols[8] || '').trim();
        const memo = (cols[9] || '').trim();

        const fare = Math.max(0, gross - hiway); // é«˜é€ŸæŠœãï¼ˆç¨è¾¼ï¼‰

        const ride = {
          time,
          type,
          fare,
          hiway,
          dist,
          startPlace: startP,
          endPlace: endP,
          memo,
          tags: []
        };

        if (!date) continue;
        if (!map.has(date)) map.set(date, { date, rides: [] });
        map.get(date).rides.push(ride);
      }

      return Array.from(map.values()).sort((a, b) => (a.date < b.date ? -1 : 1));
    }

    function mergeImportedShifts(importedShifts) {
      const byDate = new Map(state.shifts.map(s => [s.date, s]));
      importedShifts.forEach(imp => {
        const existing = byDate.get(imp.date);
        if (!existing) {
          state.shifts.push(imp);
          byDate.set(imp.date, imp);
        } else {
          existing.rides = existing.rides.concat(imp.rides);
        }
      });
    }

    // ===== Modal =====
    function openModal(h) {
      document.getElementById('modal-content').innerHTML = h;
      document.getElementById('modal-container').classList.remove('hidden');
    }

    // ===== PWA Update Bar / Service Worker =====
    (function registerSW() {
      if (!('serviceWorker' in navigator)) return;

      const updateBar = document.getElementById('update-bar');
      const updateBtn = document.getElementById('update-btn');
      let newWorker = null;

      function showUpdateBar(worker) {
        newWorker = worker;
        if (updateBar) updateBar.classList.remove('hidden');
      }

      if (updateBtn) {
        updateBtn.addEventListener('click', () => {
          if (!newWorker) return;
          newWorker.postMessage({ type: 'SKIP_WAITING' });
        });
      }

navigator.serviceWorker.register('./sw.js?v=8.5.0').then(reg => {
  if (reg.waiting) showUpdateBar(reg.waiting);

  reg.addEventListener('updatefound', () => {
    const installing = reg.installing;
    if (!installing) return;
    installing.addEventListener('statechange', () => {
      if (installing.state === 'installed' && navigator.serviceWorker.controller) {
        showUpdateBar(installing);
      }
    });
  });
}).catch(console.error);

      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        location.reload();
      });
    })();
  </script>
</body>
</html>
