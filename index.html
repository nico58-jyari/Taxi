<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>TAXI日報 PRO Ver 9.4</title>

  <meta property="og:title" content="TAXI日報 PRO" />
  <meta property="og:description" content="現役乗務員のための営収管理アプリ。地点自動取得、復元機能を搭載。" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://toprize.boo.jp/TAXI/OGP.png" />
  <meta name="twitter:card" content="summary" />

  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="TAXI日報" />
  <link rel="apple-touch-icon-precomposed" href="icon01.png" />
  <link rel="icon" type="image/png" href="icon01.png" />
  <meta name="theme-color" content="#0f172a" />

  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="max-w-md mx-auto p-4">

  <!-- ✅ 更新通知バー -->
  <div id="update-bar"
    class="hidden fixed top-2 left-1/2 -translate-x-1/2 z-[60]
           bg-slate-900 text-white px-4 py-3 rounded-2xl shadow-xl
           flex items-center gap-3 max-w-[92vw]">
    <div class="text-sm font-bold leading-snug">新しいバージョンがあります</div>
    <button id="update-btn"
      class="bg-blue-500 px-4 py-2 min-h-[44px] rounded-xl font-black whitespace-nowrap">
      更新
    </button>
  </div>

  <header class="flex justify-between items-center mb-4">
    <div>
      <h1 class="text-xl font-bold text-gray-800">🚕 TAXI日報 PRO</h1>
      <p id="clock" class="text-[10px] text-gray-400 font-mono"></p>
    </div>
    <button onclick="openSettings()" class="p-2 bg-gray-100 rounded-full text-gray-400 text-xl text-center">⚙️</button>
  </header>

  <!-- =========================
       MAIN
  ========================== -->
  <div id="page-main">

    <div id="type-selector-container" class="hidden grid grid-cols-3 gap-2 mb-4">
      <button onclick="setType('一般')" class="type-btn" id="type-一般">🚕 一般</button>
      <button onclick="setType('無線')" class="type-btn" id="type-無線">📡 無線</button>
      <button onclick="setType('付待')" class="type-btn" id="type-付待">🚉 付待</button>
    </div>

    <div id="main-controls" class="mb-4"></div>

    <div class="status-container shadow-lg">
      <div class="status-item" style="width: 20%;">
        <span class="text-[9px] text-gray-400">回数</span>
        <span class="text-xl font-bold" id="dash-count">0</span>
      </div>

      <div class="status-item bg-gray-800" style="width: 85%;">
        <span class="text-[9px] text-emerald-400 font-bold uppercase">税抜営収</span>
        <span class="text-2xl font-bold text-yellow-400" id="dash-net">0</span>
        <span class="text-[9px] text-gray-400">税込営収: ¥<span id="dash-sales">0</span></span>
      </div>


    </div>

    <div id="end-shift-container" class="hidden text-center mb-6">
      <button onclick="switchPage('share')" class="text-red-500 font-black text-lg underline decoration-2 underline-offset-4">
        勤務終了（帰庫）
      </button>
    </div>

    <!-- =========================
         INPUT FORM
    ========================== -->
    <div id="input-form" class="hidden card">
      <h2 id="form-title" class="text-center font-bold text-gray-700 mb-4 text-lg">清算入力</h2>

      <div class="space-y-4">

        <!-- ルート表示：FINISHINGのみ -->
        <div id="route-display-area" class="hidden bg-blue-50/50 rounded-xl p-4 border border-blue-100 text-center mb-4">
          <div id="start-p-display" class="text-sm text-gray-700 font-bold leading-tight"></div>
          <div class="text-blue-400 my-1 font-bold text-lg leading-none">↓</div>
          <div id="end-p-display" class="text-base text-blue-800 font-black leading-tight"></div>
        </div>

        <!-- 清算：支払入力領域（FINISHINGのみ） -->
        <div id="fare-section" class="hidden space-y-4 pt-2">

          <div class="flex items-center justify-between">
            <label class="text-sm font-bold text-gray-600">支払合計（税込）</label>
            <input
              type="number"
              id="inp-fare"
              class="w-32 p-2 border rounded-xl text-xl font-bold text-right text-blue-700 focus:outline-none"
              inputmode="numeric"
              placeholder=""
            >
          </div>

          <!-- 高速代・チップ切替ボタン -->
          <div class="flex gap-2 justify-end">
            <button type="button"
              onclick="toggleFareExtra('hiway')"
              class="px-3 py-1 text-xs font-bold rounded-full border text-red-500 border-red-200">
              高速代
            </button>
            <button type="button"
              onclick="toggleFareExtra('tip')"
              class="px-3 py-1 text-xs font-bold rounded-full border text-emerald-600 border-emerald-200">
              チップ
            </button>
          </div>

          <!-- 高速代・チップ（横並び） -->
          <div class="flex gap-4">
            <div id="hiway-area" class="hidden flex items-center justify-between w-full">
              <label class="text-sm font-bold text-red-500">🛣️高速代</label>
              <input
                type="number"
                id="inp-hiway"
                class="w-28 p-2 border rounded-xl text-lg font-bold text-right text-red-500 focus:outline-none"
                inputmode="numeric"
                placeholder="0"
              >
            </div>

            <div id="tip-area" class="hidden flex items-center justify-between w-full">
              <label class="text-sm font-bold text-emerald-600">チップ💖</label>
              <input
                type="number"
                id="inp-tip"
                class="w-28 p-2 border rounded-xl text-lg font-bold text-right text-emerald-600 focus:outline-none"
                inputmode="numeric"
                placeholder="0"
              >
            </div>
          </div>


        </div><!-- /fare-section -->

        <!-- ✅ メモ（RIDING / FINISHING 共通で1個だけ） -->
        <div id="form-memo-area" class="mt-2">
          <div class="flex justify-end">
            <button type="button"
              onclick="toggleFareExtra('memo')"
              class="px-3 py-1 text-xs font-bold rounded-full border text-gray-600 border-gray-200">
              📝メモ
            </button>
          </div>

          <div id="fare-memo-area" class="hidden mt-2">
            <textarea
              id="inp-memo"
              rows="3"
              placeholder="メモ"
              class="w-full p-3 border rounded-xl text-sm focus:outline-none"></textarea>
          </div>
        </div>

        <button onclick="handleMainAction()" id="action-btn" class="btn-main bg-blue-600 text-white shadow-lg">
          記録を保存
        </button>

        <button id="cancel-btn" class="w-full text-gray-400 text-xs py-2 text-center underline">
          キャンセル
        </button>

      </div>
    </div>

    <div id="main-current-logs" class="mt-4"></div>
  </div>

  <!-- =========================
       HISTORY
  ========================== -->
  <div id="page-history" class="hidden">
    <h2 class="text-xl font-bold mb-4 border-l-4 border-blue-500 pl-3">勤務履歴</h2>
    <div class="mb-4 relative">
      <input type="text" id="history-search" oninput="renderHistory()" placeholder="🔍 タグ・地点・日付で検索..." class="w-full p-4 pr-12 border rounded-2xl text-sm focus:outline-none shadow-sm bg-white">
      <button id="search-clear-btn" onclick="clearSearch()" class="hidden absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 text-xl font-bold p-1">✕</button>
    </div>
    <div id="period-total-card" class="mb-4"></div>
    <div id="history-content" class="space-y-3"></div>
  </div>

  <!-- =========================
       SHARE
  ========================== -->
  <div id="page-share" class="hidden">
    <div class="result-card">
      <div class="flex justify-between items-start mb-4">
        <div>
          <p class="text-yellow-400 font-black tracking-widest text-lg">DAILY RESULT</p>
          <p id="share-date-mode" class="text-[10px] text-gray-400 font-bold uppercase mt-0.5"></p>
        </div>
        <span class="text-3xl">🚕</span>
      </div>

      <div class="text-center mb-4">
        <p class="text-[9px] text-emerald-400 font-bold uppercase tracking-widest mb-1">Net Sales (税抜営収)</p>
        <div class="flex justify-center items-center">
          <span class="text-3xl font-black text-white mr-1">¥</span>
          <span class="text-5xl font-black text-white leading-none tracking-tight" id="share-net">0</span>
        </div>
        <div class="flex justify-center gap-6 mt-4 text-[10px] font-bold text-gray-500 border-t border-white/5 pt-3">
          <div class="bg-white/5 px-3 py-1 rounded-full">COUNT: <span id="share-count" class="text-white text-xs">0</span></div>
          <div id="share-dist-box" class="bg-white/5 px-3 py-1 rounded-full text-white">KM: <span id="share-km" class="text-white text-xs">0.0</span></div>
        </div>
      </div>

      <div id="share-top3" class="top3-box"></div>
      <p class="text-center text-[8px] text-gray-600 mt-6 italic tracking-[0.2em]">RECORDED BY TAXI日報 PRO</p>
    </div>

    <div class="mt-8 px-2 text-center">
      <p class="text-xl text-blue-700 font-black mb-4 italic drop-shadow-sm">📸 この画面をスクショして保存！</p>
      <button onclick="executeFinish()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black shadow-xl text-lg mb-4">この内容で勤務終了を確定</button>
      <button onclick="switchPage('main')" class="w-full text-slate-400 text-xs py-2 underline">乗務画面に戻る</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" id="nav-main" onclick="switchPage('main')"><span class="nav-icon">🚕</span>乗務</div>
    <div class="nav-item" id="nav-history" onclick="switchPage('history')"><span class="nav-icon">📖</span>履歴</div>
    <div class="nav-item" id="nav-share" onclick="switchPage('share')"><span class="nav-icon">✨</span>シェア</div>
  </nav>

  <div id="modal-container" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
    <div id="modal-content" class="bg-white rounded-3xl w-full max-sm shadow-2xl overflow-y-auto max-h-[85vh]"></div>
  </div>

  <input type="file" id="csv-file-input" class="hidden" accept=".csv,text/csv" />

  <script src="./app.js"></script>
</body>
</html>
