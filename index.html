<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAXIæ—¥å ± æ±ºå®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background-color: #f8fafc; padding-bottom: 20px; }
        .btn-main { width: 100%; padding: 16px; font-size: 1.2rem; font-weight: bold; border-radius: 12px; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-main:active { transform: translateY(2px); box-shadow: none; }
        .card { background: white; padding: 1.25rem; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœãƒ¼ãƒ‰ */
        .status-container { display: flex; background: #1e293b; color: white; border-radius: 16px; overflow: hidden; margin-bottom: 1rem; }
        .status-item { flex-direction: column; display: flex; justify-content: center; align-items: center; padding: 12px 4px; border-right: 1px solid #334155; }
        
        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹(ã‚¿ã‚°) */
        .tag-checkbox { display: none; }
        .tag-label { padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 0.8rem; font-weight: bold; color: #64748b; cursor: pointer; transition: 0.2s; }
        .tag-checkbox:checked + .tag-label { background-color: #3b82f6; color: white; border-color: #3b82f6; }

        /* è‡ªä½œãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
        #custom-modal { background: rgba(0,0,0,0.5); z-index: 100; }
        .modal-content { max-height: 85vh; overflow-y: auto; }

        .type-btn { padding: 12px 4px; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: bold; font-size: 0.9rem; background: white; width: 100%; }
        .type-btn.active { border-color: #3b82f6; background-color: #eff6ff; color: #1d4ed8; }
    </style>
</head>
<body class="max-w-md mx-auto p-4">

    <header class="flex justify-between items-center mb-4">
        <div>
            <h1 class="text-xl font-bold text-gray-800">ğŸš• TAXIæ—¥å ± PRO</h1>
            <p id="clock" class="text-xs text-gray-500 font-mono"></p>
        </div>
        <button onclick="openSettings()" class="p-2 bg-gray-100 rounded-full">âš™ï¸</button>
    </header>

    <div id="main-area"></div>

    <div class="status-container">
        <div class="status-item" style="width: 15%;">
            <span class="text-[9px] text-gray-400">å›æ•°</span>
            <span class="text-xl font-bold" id="total-count">0</span>
        </div>
        <div class="status-item bg-gray-800" style="width: 55%;">
            <span class="text-[9px] text-gray-400">å£²ä¸Š(ç¨è¾¼)</span>
            <span class="text-2xl font-bold text-yellow-400" id="total-sales">0</span>
            <span class="text-[9px] text-emerald-400">ç¨æŠœ: <span id="total-net">0</span></span>
        </div>
        <div class="status-item" style="width: 30%; border-right: none;">
            <span class="text-[9px] text-gray-400">å–¶æ¥­è·é›¢</span>
            <span class="text-xl font-bold" id="total-km">0.0</span>
            <span class="text-[9px] text-gray-500">km</span>
        </div>
    </div>

    <button onclick="openHistory()" class="w-full bg-white border border-gray-200 py-3 rounded-xl text-gray-600 font-bold mb-4 shadow-sm text-sm">ğŸ“– éå»ã®å‹¤å‹™å±¥æ­´ã‚’è¡¨ç¤º</button>

    <div id="modal-settings" class="fixed inset-0 hidden flex items-center justify-center p-4 bg-black/50 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h2 class="font-bold text-lg mb-4 text-center">ã‚¢ãƒ—ãƒªè¨­å®š</h2>
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">å‹¤å‹™ä½“åˆ¶</label>
                    <select id="set-work-mode" class="w-full p-2 border rounded-lg">
                        <option value="éš”æ—¥å‹¤å‹™">éš”æ—¥å‹¤å‹™</option>
                        <option value="æ˜¼å‹¤å‹™">æ˜¼å‹¤å‹™</option>
                        <option value="å¤œå‹¤å‹™">å¤œå‹¤å‹™</option>
                    </select>
                </div>
                <div class="flex items-center justify-between p-2 border-b">
                    <span class="text-sm">ãƒ¡ãƒ¢æ¬„ã‚’è¡¨ç¤º</span>
                    <input type="checkbox" id="set-show-memo" checked>
                </div>
                <div class="flex items-center justify-between p-2 border-b">
                    <span class="text-sm">å–¶æ¥­è·é›¢ã‚’è¡¨ç¤º</span>
                    <input type="checkbox" id="set-show-dist" checked>
                </div>
            </div>
            <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">è¨­å®šã‚’ä¿å­˜</button>
            <button onclick="closeModal('modal-settings')" class="w-full text-gray-400 py-2 mt-2 text-xs">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="modal-history" class="fixed inset-0 hidden flex items-center justify-center p-4 bg-black/50 z-50">
        <div class="bg-gray-100 rounded-2xl w-full max-w-md h-[90vh] flex flex-col">
            <div class="p-4 bg-white rounded-t-2xl border-b">
                <h2 class="font-bold text-center mb-3">å‹¤å‹™å±¥æ­´æ¤œç´¢</h2>
                <input type="text" id="hist-search" placeholder="ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢" class="w-full p-2 border rounded-lg text-sm mb-2" oninput="renderHistoryList()">
                <div class="flex gap-1 overflow-x-auto pb-1" id="hist-tags">
                    </div>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div class="p-4 bg-white border-t rounded-b-2xl">
                <button onclick="closeModal('modal-history')" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="modal-msg" class="fixed inset-0 hidden flex items-center justify-center p-4 bg-black/50 z-[100]">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl">
            <p id="msg-text" class="text-gray-800 font-bold mb-6"></p>
            <div id="msg-buttons" class="flex gap-2"></div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ã®å›ºå®šã‚­ãƒ¼
        const APP_DB = 'taxi_app_v2025_data';
        const APP_SET = 'taxi_app_v2025_settings';

        let state = {
            status: 'OFF', // OFF, WAITING, RIDING, FINISHING
            currentShift: null,
            shifts: [],
            settings: { mode: 'éš”æ—¥å‹¤å‹™', showMemo: true, showDist: true },
            tempRide: { type: 'ä¸€èˆ¬', startPlace: '', endPlace: '', tags: [], fare: 0, hiway: 0, dist: 0, memo: '' }
        };

        const TAG_LIST = ['ç—…é™¢', 'é§…', 'ãƒ›ãƒ†ãƒ«', 'ç©ºæ¸¯', 'ä¸‡å', 'æŒ‡å'];

        window.onload = () => {
            const savedData = localStorage.getItem(APP_DB);
            if (savedData) {
                const parsed = JSON.parse(savedData);
                state.shifts = parsed.shifts || [];
                state.currentShift = parsed.currentShift || null;
                state.status = parsed.status || 'OFF';
            }
            state.settings = JSON.parse(localStorage.getItem(APP_SET) || JSON.stringify(state.settings));
            
            render();
            startClock();
        };

        function startClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', weekday:'short', hour:'2-digit', minute:'2-digit', second:'2-digit' });
            };
            update(); setInterval(update, 1000);
        }

        // --- GPSå–å¾—æ©Ÿèƒ½ ---
        async function getPlaceName() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) return resolve("ä½ç½®æƒ…å ±ä¸å¯");
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&accept-language=ja`);
                        const data = await res.json();
                        const addr = data.address;
                        resolve(addr.suburb || addr.city_district || addr.city || "ä¸æ˜ãªåœ°ç‚¹");
                    } catch { resolve("å–å¾—å¤±æ•—"); }
                }, () => resolve("åœå¤–/æ‹’å¦"));
            });
        }

        // --- æç”»å‡¦ç† ---
        function render() {
            const area = document.getElementById('main-area');
            area.innerHTML = '';

            if (state.status === 'OFF') {
                area.innerHTML = `<button onclick="startShift()" class="btn-main bg-emerald-600 text-white mb-6">å‹¤å‹™é–‹å§‹ï¼ˆå‡ºåº«ï¼‰</button>`;
            } 
            else if (state.status === 'WAITING') {
                area.innerHTML = `
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button onclick="setRideType('ä¸€èˆ¬')" class="type-btn ${state.tempRide.type==='ä¸€èˆ¬'?'active':''}">ğŸš• ä¸€èˆ¬</button>
                        <button onclick="setRideType('ç„¡ç·š')" class="type-btn ${state.tempRide.type==='ç„¡ç·š'?'active':''}">ğŸ“¡ ç„¡ç·š</button>
                        <button onclick="setRideType('ä»˜å¾…')" class="type-btn ${state.tempRide.type==='ä»˜å¾…'?'active':''}">ğŸš‰ ä»˜å¾…</button>
                    </div>
                    <button onclick="startRide()" class="btn-main bg-blue-600 text-white mb-8">ä¹—è»Šé–‹å§‹</button>
                    <button onclick="confirmEndShift()" class="w-full bg-red-500 text-white py-4 rounded-xl font-extrabold shadow-lg mb-6">ğŸ å‹¤å‹™çµ‚äº†ï¼ˆå¸°åº«ï¼‰</button>
                `;
            }
            else if (state.status === 'RIDING') {
                area.innerHTML = `
                    <div class="card border-l-8 border-orange-500">
                        <div class="text-center font-bold text-orange-600 mb-4 animate-pulse">è³ƒèµ°ä¸­ï¼š${state.tempRide.type}</div>
                        <div class="flex flex-wrap gap-2 justify-center mb-6">
                            ${TAG_LIST.map(tag => `
                                <input type="checkbox" id="tag-${tag}" class="tag-checkbox" onchange="toggleTag('${tag}')" ${state.tempRide.tags.includes(tag)?'checked':''}>
                                <label for="tag-${tag}" class="tag-label">${tag}</label>
                            `).join('')}
                        </div>
                        <button onclick="finishRide()" class="btn-main bg-blue-600 text-white mb-4">ãŠå®¢æ§˜é™è»Šï¼ˆæ¸…ç®—ï¼‰</button>
                        ${state.settings.showMemo ? `<textarea id="memo-riding" class="w-full p-2 border rounded text-sm mb-2" placeholder="å®Ÿè»Šä¸­ã®ãƒ¡ãƒ¢..." oninput="state.tempRide.memo=this.value">${state.tempRide.memo}</textarea>` : ''}
                        ${state.settings.showDist ? `<div class="text-right text-gray-400 text-xs italic">å–¶æ¥­è·é›¢ã®å…¥åŠ›ã¯é™è»Šæ™‚ã«è¡Œã„ã¾ã™</div>` : ''}
                    </div>
                `;
            }
            else if (state.status === 'FINISHING') {
                area.innerHTML = `
                    <div class="card bg-blue-50 border-t-4 border-blue-600">
                        <div class="text-center mb-4">
                            <div class="text-xs text-gray-500">å®Ÿè»Šåœ°ï¼š${state.tempRide.startPlace}</div>
                            <div class="text-xl my-1">â¬‡ï¸</div>
                            <div class="font-bold text-blue-800">${state.tempRide.endPlace || 'åœ°åå–å¾—ä¸­...'}</div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="font-bold">å£²ä¸Š(ç¨è¾¼)</span>
                                <input type="number" id="inp-fare" class="text-right text-2xl font-bold w-1/2 p-2 border rounded" inputmode="numeric" placeholder="0">
                            </div>
                            <div class="border-t border-dashed my-2"></div>
                            <div class="flex items-center justify-between">
                                <span class="font-bold text-red-600">é«˜é€Ÿä»£</span>
                                <input type="number" id="inp-hiway" class="text-right text-xl font-bold text-red-600 w-1/2 p-2 border rounded" inputmode="numeric" placeholder="0">
                            </div>
                            
                            <div class="flex flex-wrap gap-1 justify-center py-2">
                                ${TAG_LIST.map(tag => `
                                    <input type="checkbox" id="tag2-${tag}" class="tag-checkbox" onchange="toggleTag('${tag}')" ${state.tempRide.tags.includes(tag)?'checked':''}>
                                    <label for="tag2-${tag}" class="tag-label">${tag}</label>
                                `).join('')}
                            </div>

                            ${state.settings.showMemo ? `<input type="text" id="inp-memo" value="${state.tempRide.memo}" class="w-full p-2 border rounded text-sm" placeholder="ãƒ¡ãƒ¢">` : ''}
                            ${state.settings.showDist ? `<div class="flex items-center justify-between"><span class="text-sm">å–¶æ¥­è·é›¢(km)</span><input type="number" id="inp-dist" class="text-right w-1/3 p-2 border rounded" inputmode="decimal" placeholder="0.0"></div>` : ''}
                            
                            <button onclick="commitRide()" class="btn-main bg-emerald-600 text-white">è¨˜éŒ²ã‚’ä¿å­˜</button>
                            <button onclick="state.status='WAITING';render();" class="w-full text-gray-400 text-xs py-2">å…¥åŠ›ã‚’ä¸­æ­¢</button>
                        </div>
                    </div>
                `;
            }

            updateDashboard();
            saveToStorage();
        }

        function updateDashboard() {
            const active = state.currentShift || { rides: [] };
            const sales = active.rides.reduce((s, r) => s + Number(r.fare), 0);
            const km = active.rides.reduce((s, r) => s + Number(r.dist), 0);
            document.getElementById('total-count').innerText = active.rides.length;
            document.getElementById('total-sales').innerText = sales.toLocaleString();
            document.getElementById('total-net').innerText = Math.floor(sales / 1.1).toLocaleString();
            document.getElementById('total-km').innerText = km.toFixed(1);
        }

        // --- ãƒ­ã‚¸ãƒƒã‚¯ ---
        function startShift() {
            state.currentShift = { id: Date.now(), date: new Date().toLocaleDateString('ja-JP'), rides: [] };
            state.status = 'WAITING';
            render();
        }

        function setRideType(t) { state.tempRide.type = t; render(); }
        
        async function startRide() {
            state.status = 'RIDING';
            state.tempRide = { ...state.tempRide, startPlace: 'å–å¾—ä¸­...', endPlace: '', fare: 0, hiway: 0, dist: 0, memo: '', tags: [] };
            render();
            state.tempRide.startPlace = await getPlaceName();
            render();
        }

        async function finishRide() {
            state.status = 'FINISHING';
            render();
            state.tempRide.endPlace = await getPlaceName();
            render();
        }

        function toggleTag(t) {
            if (state.tempRide.tags.includes(t)) state.tempRide.tags = state.tempRide.tags.filter(x => x !== t);
            else state.tempRide.tags.push(t);
        }

        function commitRide() {
            const f = parseInt(document.getElementById('inp-fare').value) || 0;
            const h = parseInt(document.getElementById('inp-hiway').value) || 0;
            const d = parseFloat(document.getElementById('inp-dist')?.value) || 0;
            const m = document.getElementById('inp-memo')?.value || '';
            
            state.currentShift.rides.push({
                ...state.tempRide,
                time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
                fare: f - h,
                hiway: h,
                dist: d,
                memo: m
            });
            state.status = 'WAITING';
            state.tempRide = { type: 'ä¸€èˆ¬', tags: [] };
            render();
        }

        function confirmEndShift() {
            showMsg("æœ¬æ—¥ã®å‹¤å‹™ã‚’çµ‚äº†ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ", [
                { text: "çµ‚äº†", color: "bg-red-600", click: () => {
                    state.shifts.push(state.currentShift);
                    state.currentShift = null;
                    state.status = 'OFF';
                    closeModal('modal-msg');
                    render();
                }},
                { text: "æˆ»ã‚‹", color: "bg-gray-200 text-gray-800", click: () => closeModal('modal-msg') }
            ]);
        }

        // --- è¨­å®šãƒ»å±¥æ­´ ---
        function openSettings() {
            document.getElementById('modal-settings').classList.remove('hidden');
        }
        function saveSettings() {
            state.settings.mode = document.getElementById('set-work-mode').value;
            state.settings.showMemo = document.getElementById('set-show-memo').checked;
            state.settings.showDist = document.getElementById('set-show-dist').checked;
            localStorage.setItem(APP_SET, JSON.stringify(state.settings));
            closeModal('modal-settings');
            render();
        }

        function openHistory() {
            document.getElementById('modal-history').classList.remove('hidden');
            const tagArea = document.getElementById('hist-tags');
            tagArea.innerHTML = TAG_LIST.map(t => `<button onclick="filterHistory('${t}')" class="bg-gray-200 px-3 py-1 rounded-full text-[10px] font-bold whitespace-nowrap">${t}</button>`).join('');
            renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            const word = document.getElementById('hist-search').value;
            list.innerHTML = '';
            
            [...state.shifts].reverse().forEach(s => {
                const total = s.rides.reduce((sum, r) => sum + Number(r.fare), 0);
                const match = s.rides.some(r => r.memo.includes(word) || r.tags.join('').includes(word));
                if (word && !match && !s.date.includes(word)) return;

                list.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border">
                        <div class="flex justify-between font-bold text-sm mb-2"><span>${s.date}</span><span class="text-blue-600">Â¥${total.toLocaleString()}</span></div>
                        <div class="space-y-1">
                            ${s.rides.map(r => `
                                <div class="text-[10px] text-gray-500 border-b pb-1 flex justify-between">
                                    <span>${r.time} ${r.startPlace}â†’${r.endPlace}</span>
                                    <span>Â¥${Number(r.fare).toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
        }

        function filterHistory(tag) { document.getElementById('hist-search').value = tag; renderHistoryList(); }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function showMsg(text, buttons) {
            document.getElementById('msg-text').innerText = text;
            const btnArea = document.getElementById('msg-buttons');
            btnArea.innerHTML = '';
            buttons.forEach(b => {
                const btn = document.createElement('button');
                btn.className = `flex-1 py-3 rounded-xl font-bold text-sm ${b.color}`;
                btn.innerText = b.text;
                btn.onclick = b.click;
                btn.type = "button";
                btnArea.appendChild(btn);
            });
            document.getElementById('modal-msg').classList.remove('hidden');
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function saveToStorage() { localStorage.setItem(APP_DB, JSON.stringify({ shifts: state.shifts, currentShift: state.currentShift, status: state.status })); }
        function clearSystem() { if(confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
